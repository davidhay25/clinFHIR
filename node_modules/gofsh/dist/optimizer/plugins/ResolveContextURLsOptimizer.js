"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fsh_sushi_1 = require("fsh-sushi");
const utils_1 = require("../utils");
const valid_url_1 = require("valid-url");
const FISHER_TYPES = [
    fsh_sushi_1.utils.Type.Resource,
    fsh_sushi_1.utils.Type.Type,
    fsh_sushi_1.utils.Type.Profile,
    fsh_sushi_1.utils.Type.Extension,
    fsh_sushi_1.utils.Type.Logical
];
exports.default = {
    name: 'resolve_context_urls',
    description: 'Replace declared extension context URLs with their names or aliases',
    optimize(pkg, fisher, options = {}) {
        for (const extension of pkg.extensions) {
            if (extension.contexts) {
                extension.contexts.forEach(context => {
                    var _a, _b;
                    if (!context.isQuoted) {
                        // if the context is an extension, value is just a url without a #
                        // if the context is an element of a non-core resource, value is a url, #, and a path
                        if (context.value.indexOf('#') > -1) {
                            const [url, path] = context.value.split('#');
                            const newUrl = (0, utils_1.optimizeURL)(url, pkg.aliases, FISHER_TYPES, fisher, (_a = options.alias) !== null && _a !== void 0 ? _a : true);
                            if (newUrl !== url) {
                                let separator;
                                if (newUrl.startsWith('$')) {
                                    separator = '#';
                                }
                                else {
                                    separator = '.';
                                }
                                context.value = `${newUrl}${separator}${path}`;
                            }
                        }
                        else if ((0, valid_url_1.isUri)(context.value)) {
                            context.value = (0, utils_1.optimizeURL)(context.value, pkg.aliases, FISHER_TYPES, fisher, (_b = options.alias) !== null && _b !== void 0 ? _b : true);
                        }
                    }
                });
            }
        }
    }
};
//# sourceMappingURL=ResolveContextURLsOptimizer.js.map