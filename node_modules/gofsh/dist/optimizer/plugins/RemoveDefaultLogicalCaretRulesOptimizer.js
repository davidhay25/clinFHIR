"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const exportable_1 = require("../../exportable");
const lodash_1 = require("lodash");
const fsh_sushi_1 = require("fsh-sushi");
const rules_1 = require("fsh-sushi/dist/fshtypes/rules");
const { FshCode } = fsh_sushi_1.fshtypes;
exports.default = {
    name: 'remove_default_logical_caret_rules_optimizer',
    description: 'Remove caret rules on a Logical that provide values that will be provided by default SUSHI behavior',
    optimize(pkg) {
        // * ^kind = #logical
        const DEFAULT_KIND = new exportable_1.ExportableCaretValueRule('');
        DEFAULT_KIND.caretPath = 'kind';
        DEFAULT_KIND.value = new FshCode('logical');
        // * ^abstract = false
        const DEFAULT_ABSTRACT = new exportable_1.ExportableCaretValueRule('');
        DEFAULT_ABSTRACT.caretPath = 'abstract';
        DEFAULT_ABSTRACT.value = false;
        // * ^type = {the Logical's URL}
        const DEFAULT_TYPE = new exportable_1.ExportableCaretValueRule('');
        DEFAULT_TYPE.caretPath = 'type';
        // check for these on Logicals
        pkg.logicals.forEach(logical => {
            const ruleIndicesToRemove = [];
            const urlRule = logical.rules.find(rule => rule instanceof rules_1.CaretValueRule && rule.path === '' && rule.caretPath === 'url');
            if (urlRule) {
                DEFAULT_TYPE.value = urlRule.value;
            }
            else {
                DEFAULT_TYPE.value = `${pkg.configuration.config.canonical}/StructureDefinition/${logical.id}`;
            }
            logical.rules.forEach((rule, idx) => {
                if (rule instanceof exportable_1.ExportableCaretValueRule &&
                    ((0, lodash_1.isEqual)(rule, DEFAULT_KIND) ||
                        (0, lodash_1.isEqual)(rule, DEFAULT_ABSTRACT) ||
                        (0, lodash_1.isEqual)(rule, DEFAULT_TYPE))) {
                    ruleIndicesToRemove.push(idx);
                }
            });
            if (ruleIndicesToRemove.length > 0) {
                (0, lodash_1.pullAt)(logical.rules, ...ruleIndicesToRemove);
            }
        });
    }
};
//# sourceMappingURL=RemoveDefaultLogicalCaretRulesOptimizer.js.map